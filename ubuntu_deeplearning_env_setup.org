#+TITLE:     Ubuntu + CUDA + Tensorflow + PyTorch
#+html_head: <link rel="stylesheet" type="text/css" href="../css/article.css" />
#+html_head: <link rel="stylesheet" type="text/css" href="../css/toc.css" />

#+INDEX: tensorflow, pytorch, cuda

* Install Ubuntu 18.04
  Should be easy.

* Install Nvidia Device Driver
  Add PPA repository of Nvidia drivers.
#+begin_src sh
  sudo add-apt-repository ppa:graphics-drivers/ppa
#+end_src

  List Nvidia devices
#+begin_src sh
  lspci | grep VGA
#+end_src

#+begin_example
  01:00.0 VGA compatible controller: NVIDIA Corporation Device 1f07 (rev a1)
#+end_example

  List available drivers
#+begin_src sh
  sudo ubuntu-drivers devices
#+end_src
#+begin_example
  == /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0 ==
  modalias : pci:v000010DEd00001F07sv00001043sd00008681bc03sc00i00
  vendor   : NVIDIA Corporation
  driver   : nvidia-driver-415 - third-party free
  driver   : nvidia-driver-418 - third-party free
  driver   : nvidia-driver-410 - third-party free
  driver   : nvidia-driver-430 - third-party free recommended
  driver   : xserver-xorg-video-nouveau - distro free builtin
#+end_example

  Install recommended driver
#+begin_src sh
  sudo ubuntu-drivers install
#+end_src

  Check installation
#+begin_src sh
  nvidia-smi
#+end_src
* Install CUDA/CUDNN toolkit
  Should be easy.

* Python VirtualEnv
#+begin_src sh
sudo apt install virtualenv
virtualenv -p /usr/bin/python3 .env
. .env/bin/activate
#+end_src

* Install TensorFlow
  Install the stable version with GPU supported.
#+begin_src sh
  pip install tensorflow-gpu
#+end_src
  Install tensorflow 2.0.0 beta.
#+begin_src sh
  pip install tensorflow-gpu==2.0.0b0
#+end_src

  The "Conv2D CUDNN handle issue"[fn:1][fn:2]
#+begin_src python
  # for tf 1.x
  config = tf.ConfigProto(allow_soft_placement=True)
  config.gpu_options.allow_growth = True
  sess = tf.Session(config=config)

  # for tf 2.0
  gpus = tf.config.experimental.list_physical_devices('GPU')
  for gpu in gpus:
      tf.config.experimental.set_memory_growth(gpu, True)
#+end_src

** Build TensorFlow from source code[fn:3]
   Download tensorflow source code
#+begin_src sh
  git clone git@github.com:tensorflow/tensorflow.git
  git checkout r1.9
#+end_src

   Install bazel
#+begin_src sh
  wget https://github.com/bazelbuild/bazel/releases/download/0.26.1/bazel-0.26.1-installer-linux-x86_64.sh
  chmod a+x *.sh
  ./bazel-0.26.1-installer-linux-x86_64.sh --prefix=~/.local
  # set PATH if not yet
  # export PATH=$PATH:~/.local/bin
#+end_src

* Install PyTorch
#+begin_src sh
  pip install torch torchvision
#+end_src

* Miscs
** Install Matplotlib
#+begin_src sh
sudo apt install python3-tk
pip install matplotlib
#+end_src

** Jupyter Notebook
   Install jupyter notebook.
#+begin_src sh
  pip install jupyter
#+end_src

   Start jupyter notebook
#+begin_src sh
  jupyter notebook
#+end_src

[fn:1] [[https://tensorflow.google.cn/beta/guide/using_gpu][TF Guide: Using GPU]]
[fn:2] [[https://github.com/tensorflow/tensorflow/issues/6698][issue-6698]]
[fn:3] [[https://tensorflow.google.cn/install/source][Build TF from Source]]
